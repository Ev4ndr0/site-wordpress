version: "3"

services:
    br_com_site:
        container_name: ${SERVICE_SERVER_NAME}
        restart: always
        build:
            context: ./docker/wordpress
            dockerfile: Dockerfile
            args:
                - PHP_VERSION=${PHP_VERSION}
                - WORDPRESS_VERSION=${WORDPRESS_VERSION}
        environment:
            # global
            - WORDPRESS_DEBUG=${WORDPRESS_DEBUG}
            - WORDPRESS_TABLE_PREFIX=${WORDPRESS_TABLE_PREFIX}
            - WORDPRESS_CONFIG_EXTRA=${WORDPRESS_CONFIG_EXTRA}
            - WORDPRESS_DB_CHARSET=${WORDPRESS_DB_CHARSET}
            - WORDPRESS_DB_COLLATE=${WORDPRESS_DB_COLLATE}
            # common
            - WORDPRESS_DB_HOST=${WORDPRESS_DB_HOST}
            - WORDPRESS_DB_USER=${WORDPRESS_DB_USER}
            - WORDPRESS_DB_PASSWORD=${WORDPRESS_DB_PASSWORD}
            - WORDPRESS_DB_NAME=${WORDPRESS_DB_NAME}
            # secret-keys (generated by wp-cli)
            - WORDPRESS_AUTH_KEY=${WORDPRESS_AUTH_KEY}
            - WORDPRESS_SECURE_AUTH_KEY=${WORDPRESS_SECURE_AUTH_KEY}
            - WORDPRESS_LOGGED_IN_KEY=${WORDPRESS_LOGGED_IN_KEY}
            - WORDPRESS_NONCE_KEY=${WORDPRESS_NONCE_KEY}
            - WORDPRESS_AUTH_SALT=${WORDPRESS_AUTH_SALT}
            - WORDPRESS_SECURE_AUTH_SALT=${WORDPRESS_SECURE_AUTH_SALT}
            - WORDPRESS_LOGGED_IN_SALT=${WORDPRESS_LOGGED_IN_SALT}
            - WORDPRESS_NONCE_SALT=${WORDPRESS_NONCE_SALT}
        volumes:
            - ${SERVICE_SOURCE_DIR}/wp-content:/var/www/html/wp-content
            - ${SERVICE_SOURCE_DIR}/.logs:/var/log/apache2
            - ./src/.certs:/etc/apache2/ssl
        ports:
            - ${SERVICE_SERVER_PORT}:80
        depends_on:
            - db
        networks:
            - network-site

    db:
        image: mysql:${MYSQL_VERSION}
        container_name: db
        restart: always
        environment:
            MYSQL_DATABASE: ${WORDPRESS_DB_NAME}
            MYSQL_USER: ${WORDPRESS_DB_USER}
            MYSQL_PASSWORD: ${WORDPRESS_DB_PASSWORD}
            MYSQL_ROOT_PASSWORD: ${WORDPRESS_DB_PASSWORD}
        ports:
            - ${WORDPRESS_DB_PORT}:3306
        expose:
            - 3306
        volumes:
            - ./mysql:/var/lib/mysql
        networks:
            - network-site
networks:
    network-site:
        driver: bridge
